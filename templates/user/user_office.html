<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç ‚Äî Almaways</title>

  <!-- –®—Ä–∏—Ñ—Ç—ã/–ò–∫–æ–Ω–∫–∏ -->
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;800&family=Playfair+Display:wght@700;800&display=swap" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"/>

  <style>
    /* =====================
       DESIGN TOKENS (V3)
       ===================== */
    :root{
      --bg:#F9FBFF; --panel:#FFFFFF; --ink:#0B1220; --muted:#566179;
      --primary:#B5CEF5; --secondary:#2E6D9C; --ring:#B5CEF5;
      --r-s:12px; --r-m:16px; --r-l:22px; --pill:999px;
      --s-s:0 6px 18px rgba(2,6,23,.06);
      --s-m:0 14px 34px rgba(2,6,23,.10);
      --s-l:0 24px 64px rgba(46,109,156,.22);
    }

    /* ========== –ë–ê–ó–ê ========== */
    html,body{height:100%;background:var(--bg);color:var(--ink);font-family:'Poppins',system-ui,sans-serif;line-height:1.5;overflow-x:hidden}
    *,*:before,*:after{box-sizing:border-box}
    img,video{display:block;max-width:100%;height:auto}
    a{color:var(--secondary);text-decoration:none}
    .container{max-width:1200px;margin:0 auto;padding:0 16px}

    /* –ì–∞—Ä–∞–Ω—Ç–∏—è, —á—Ç–æ —á—É–∂–∏–µ/—Å–ª—É—á–∞–π–Ω—ã–µ –∫–∞—Ä—Ç–∏–Ω–∫–∏ –Ω–µ –≤—ã–≤–∞–ª—è—Ç—Å—è –Ω–∞ —ç–∫—Ä–∞–Ω */
    body.office > img:not([class]), body.office > picture:not([class]){display:none!important}

    /* ========== –•–ï–î–ï–† + –ë–£–†–ì–ï–† (–∫–∞–∫ –≤ index) ========== */
    .header{position:sticky;top:0;z-index:50;height:64px;display:flex;align-items:center;justify-content:space-between;padding:0 16px;background:rgba(255,255,255,.9);backdrop-filter:blur(12px);border-bottom:1px solid rgba(2,6,23,.06)}
    .brand{display:flex;align-items:center;gap:10px}
    .brand img{height:32px}
    .brand strong{color:var(--secondary)}
    .burger-menu{width:28px;height:20px;display:flex;flex-direction:column;justify-content:space-between;cursor:pointer}
    .burger-menu span{height:3px;background:var(--ink);border-radius:3px;transition:.25s}
    .burger-menu.active span:nth-child(1){transform:translateY(8px) rotate(45deg)}
    .burger-menu.active span:nth-child(2){opacity:0}
    .burger-menu.active span:nth-child(3){transform:translateY(-8px) rotate(-45deg)}

    .sidebar{position:fixed;inset:0 auto 0 0;width:320px;background:var(--panel);transform:translateX(-100%);transition:.3s transform;z-index:60;border-right:1px solid #e6eef8;box-shadow:var(--s-m);overflow:auto}
    .sidebar.active{transform:translateX(0)}
    .overlay{position:fixed;inset:0;background:rgba(11,18,32,.28);opacity:0;visibility:hidden;transition:.2s;z-index:55}
    .overlay.active{opacity:1;visibility:visible}

    .profile-card{padding:18px 16px;display:flex;align-items:center;gap:12px}
    .profile-card .avatar{width:84px;height:84px;border-radius:999px;border:3px solid var(--primary);object-fit:cover;object-position:center;box-shadow:var(--s-m);cursor:pointer}
    .avatar-wrap{position:relative;display:inline-block}
    .avatar-badge{position:absolute;right:-2px;bottom:-2px;width:26px;height:26px;border-radius:999px;background:var(--secondary);color:#fff;display:grid;place-items:center;font-size:.8rem;box-shadow:0 4px 10px rgba(46,109,156,.25)}
    .menu{display:flex;flex-direction:column;gap:6px;padding:8px 14px 18px}
    .menu a{display:flex;align-items:center;gap:.7rem;padding:10px 12px;border-radius:12px;color:var(--ink);transition:.2s background,.2s transform}
    .menu a:hover{background:#f7faff;transform:translateX(2px)}

    .lang-switcher{margin:12px 14px 20px;display:flex;gap:6px;background:#f1f5f9;border-radius:999px;padding:6px}
    .lang-btn{flex:1;border:0;background:transparent;color:var(--ink);padding:.45rem .7rem;border-radius:999px;font-weight:600;cursor:pointer}
    .lang-btn.active{background:var(--secondary);color:#fff}

    .promo{margin:0 14px 24px;border-radius:18px;padding:18px;background:linear-gradient(135deg,#EAF2FE,#ffffff);color:#243c5a;box-shadow:var(--s-m)}

    /* ========== –ö–ù–û–ü–ö–ò/–ò–ù–ü–£–¢–´ ========== */
    .btn{display:inline-flex;align-items:center;gap:.6rem;border:0;border-radius:var(--pill);padding:.85rem 1.25rem;font-weight:800;color:#fff;background:linear-gradient(180deg,var(--secondary),var(--primary));box-shadow:0 12px 26px rgba(46,109,156,.25);transition:transform .18s, box-shadow .18s}
    .btn:hover{transform:translateY(-2px);box-shadow:0 18px 34px rgba(46,109,156,.28)}
    .btn.ghost{background:#fff;color:var(--secondary);border:1px solid var(--primary);box-shadow:var(--s-s)}
    .input{background:var(--panel);border:1px solid #e6eef8;border-radius:var(--r-m);padding:12px 14px;color:var(--ink)}
    .input:focus{outline:2px solid var(--ring);box-shadow:0 0 0 3px rgba(46,109,156,.12)}

    /* ========== –°–ï–ö–¶–ò–ò –ö–ê–ë–ò–ù–ï–¢–ê ========== */
    .page{padding:18px 0 28px}
    .banner{position:relative;overflow:hidden;border-radius:var(--r-l);background:radial-gradient(800px 240px at 10% -10%, rgba(181,206,245,.28), transparent),linear-gradient(180deg,#fff,#f7fbff);box-shadow:var(--s-m)}
    .banner .inner{display:grid;grid-template-columns:min-content 1fr auto;gap:16px;align-items:center;padding:18px}
    .banner .avatar-lg{width:clamp(72px,9vw,96px);height:clamp(72px,9vw,96px);border-radius:999px;border:3px solid var(--primary);object-fit:cover;object-position:center;box-shadow:var(--s-m)}
    .banner .name{margin:0;font-family:'Playfair Display',serif;font-weight:800;font-size:clamp(1.4rem,3.4vw,2.2rem)}
    .chips{display:flex;flex-wrap:wrap;gap:10px}
    .chip{display:inline-flex;align-items:center;gap:.35rem;border-radius:var(--pill);padding:.25rem .65rem;background:#EAF2FE;color:var(--secondary);font-weight:700;font-size:.82rem}
    @media(max-width:640px){.banner .inner{grid-template-columns:min-content 1fr}.banner .actions{grid-column:1/-1;justify-self:start;display:flex;gap:10px;margin-top:8px}}

    .grid{display:grid;grid-template-columns:1.2fr .8fr;gap:22px;margin-top:18px}
    @media(max-width:1024px){.grid{grid-template-columns:1fr}}

    .card{background:var(--panel);border:1px solid #e6eef8;border-radius:var(--r-l);box-shadow:var(--s-s);padding:16px}
    .kpis{display:grid;grid-template-columns:repeat(4,1fr);gap:14px}
    @media(max-width:900px){.kpis{grid-template-columns:repeat(2,1fr)}}
    @media(max-width:520px){.kpis{grid-template-columns:1fr}}
    .kpi{background:var(--panel);border:1px solid #e6eef8;border-radius:16px;padding:16px;box-shadow:var(--s-s)}
    .kpi h4{margin:0 0 4px;font-size:1rem;color:#0b3b59}
    .kpi .val{font-size:1.8rem;font-weight:800;color:var(--secondary)}

    .progress{display:grid;grid-template-columns:auto 1fr;gap:16px;align-items:center}
    .ring{position:relative;width:120px;height:120px;display:grid;place-items:center}
    .ring svg{transform:rotate(-90deg)}

    .tabs{display:flex;gap:8px;flex-wrap:wrap}
    .tab{border:1px solid #e6eef8;background:#fff;color:var(--ink);border-radius:var(--pill);padding:.55rem .9rem;font-weight:700}
    .tab.active{background:var(--secondary);color:#fff}
    .panel{display:none}
    .panel.active{display:block}

    .mini-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:14px}
    .mini-card{background:var(--panel);border:1px solid #e6eef8;border-radius:16px;overflow:hidden;box-shadow:var(--s-s)}
    .mini-card img{width:100%;aspect-ratio:16/10;object-fit:cover}
    .mini-card .info{padding:12px}
  </style>
</head>

<body class="office">
  <!-- ===== –•–ï–î–ï–† ===== -->
  <header class="header">
    <div class="burger-menu" id="burger-menu"><span></span><span></span><span></span></div>
    <div class="brand">
      <img src="{{ url_for('static', filename='img/logo.png') }}" alt="Logo"/>
      <strong>Almaways</strong>
    </div>
    <div class="hidden sm:flex items-center gap-2">
      <a href="/index" class="btn ghost" style="padding:.55rem 1rem">–ù–∞ –≥–ª–∞–≤–Ω—É—é</a>
      <a href="/favourites" class="btn" style="padding:.55rem 1rem">–ò–∑–±—Ä–∞–Ω–Ω–æ–µ</a>
    </div>
  </header>

  <!-- ===== –°–ê–ô–î–ë–ê–† ===== -->
  <aside class="sidebar" id="sidebar">
    <div class="profile-card">
      <form id="avatar-form" enctype="multipart/form-data" onsubmit="return false;">
        <label for="avatar-input" class="avatar-wrap" id="avatar-label">
          <img id="avatar-img" class="avatar" alt="avatar" src="{{ url_for('static', filename='avatars/' ~ (current_user.avatar or 'default.png')) }}"/>
          <span class="avatar-badge" id="avatar-badge"><i class="fa fa-camera"></i></span>
        </label>
        <input id="avatar-input" name="avatar" type="file" accept="image/png,image/jpeg,image/webp" style="display:none"/>
      </form>
      <div>
        <h3 style="margin:0">{{ current_user.name }} {{ current_user.surname }}</h3>
        <p class="email" style="color:#64748b">{{ current_user.email }}</p>
        <div class="chip"><i class="fas fa-star"></i> 4.8</div>
      </div>
    </div>
    <nav class="menu">
      <a href="/index"><i class="fas fa-home"></i>–ì–ª–∞–≤–Ω–∞—è</a>
      <a href="/favourites"><i class="fas fa-route"></i>–ú–æ–∏ –º–∞—Ä—à—Ä—É—Ç—ã</a>
      <a href="/user_office" class="active"><i class="fas fa-user"></i>–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</a>
      <a href="/logout"><i class="fas fa-sign-out-alt"></i>–í—ã—Ö–æ–¥</a>
    </nav>
    <div class="lang-switcher" id="lang-switcher">
      <button class="lang-btn active" data-lang="ru">üá∑üá∫ RU</button>
      <button class="lang-btn" data-lang="kz">üá∞üáø KZ</button>
      <button class="lang-btn" data-lang="en">üá¨üáß EN</button>
    </div>
    <div class="promo">
      <h3 style="margin:0 0 6px">–ü—Ä–µ–º–∏—É–º –¥–æ—Å—Ç—É–ø</h3>
      <p style="margin:0">–û—Ñ–ª–∞–π–Ω‚Äë—Ç—Ä–µ–∫, —ç–∫—Å–ø–æ—Ä—Ç GPX –∏ AR‚Äë–ø–æ–¥—Å–∫–∞–∑–∫–∏</p>
      <div style="margin-top:10px"><button class="btn" style="width:100%">–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å</button></div>
    </div>
  </aside>
  <div class="overlay" id="overlay"></div>

  <!-- ===== –ö–û–ù–¢–ï–ù–¢ ===== -->
  <main class="container page">
    <!-- –ü—Ä–æ—Ñ–∏–ª—å–Ω—ã–π –±–∞–Ω–Ω–µ—Ä -->
    <section class="banner">
      <div class="inner">
        <img class="avatar-lg" alt="avatar" src="{{ url_for('static', filename='avatars/' ~ (current_user.avatar or 'default.png')) }}"/>
        <div>
          <h1 class="name">{{ current_user.name }} {{ current_user.surname }}</h1>
          <div class="chips">
            <span class="chip">ID: {{ current_user.id }}</span>
            <span class="chip">Email: {{ current_user.email }}</span>
            <span class="chip">–°—Ç–∞—Ç—É—Å: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</span>
          </div>
          <div class="chips" style="margin-top:10px">
            <a class="btn" href="/favourites"><i class="fa-solid fa-heart"></i> –ò–∑–±—Ä–∞–Ω–Ω–æ–µ</a>
            <a class="btn ghost" href="/index"><i class="fa-solid fa-compass"></i> –ù–∞–π—Ç–∏ –º–∞—Ä—à—Ä—É—Ç</a>
          </div>
        </div>
        <div class="actions">
          <div class="chip"><i class="fa-regular fa-clock"></i> –ê–∫—Ç–∏–≤–µ–Ω</div>
        </div>
      </div>
    </section>

    <!-- KPI + –ü—Ä–æ–≥—Ä–µ—Å—Å -->
    <section class="grid">
      <div class="card">
        <div class="kpis">
          <div class="kpi"><h4>–ó–∞–≤–µ—Ä—à–µ–Ω–æ –º–∞—Ä—à—Ä—É—Ç–æ–≤</h4><div class="val">{{ completed }}</div></div>
          <div class="kpi"><h4>–í—Å–µ–≥–æ —á–∞—Å–æ–≤ –≤ –ø—É—Ç–∏</h4><div class="val">{{ total_hours }}</div></div>
          <div class="kpi"><h4>–§–æ—Ç–æ –≤ –ø—Ä–æ—Ñ–∏–ª–µ</h4><div class="val">{{ total_photos }}</div></div>
        </div>
      </div>
      <div class="card">
        <div class="progress" data-completed="{{ completed or 0 }}"
     data-total="{{ total_routes or 0 }}"
     data-progress="{{ progress if progress is not none else '' }}">
     
            {# === –ü–†–û–ì–†–ï–°–° === #}
            {% set _completed = (completed or 0)|int %}
            {% set _total = (total_routes or 0)|int %}
            {% set raw = progress if progress is not none else (_completed / _total if _total > 0 else 0) %}
            {# raw –º–æ–∂–µ—Ç –±—ã—Ç—å 0‚Äì1 (–¥–æ–ª—è) –∏–ª–∏ 0‚Äì100 (–ø—Ä–æ—Ü–µ–Ω—Ç—ã) #}
            {% set p = (((raw * 100) if raw <= 1 else raw)|round(0, 'floor')|int) %}

            {% set R = 54 %}
            {% set C = 2 * 3.14159 * R %}
            {% set D = (C * p) / 100 %}


          <div class="ring" aria-label="–ü—Ä–æ–≥—Ä–µ—Å—Å">
            <svg width="120" height="120" viewBox="0 0 120 120">
              <circle cx="60" cy="60" r="54" fill="none" stroke="#eef3fb" stroke-width="12"/>
              <circle cx="60" cy="60" r="54" fill="none" stroke="url(#grad)" stroke-width="12" stroke-linecap="round" stroke-dasharray="{{ D }}, {{ C }}"/>
              <defs>
                <linearGradient id="grad" x1="0" x2="0" y1="0" y2="1">
                  <stop offset="0%" stop-color="var(--secondary)"/>
                  <stop offset="100%" stop-color="var(--primary)"/>
                </linearGradient>
              </defs>
            </svg>
          </div>
          <div>
            <h3 style="margin:0 0 6px">–ü—Ä–æ–≥—Ä–µ—Å—Å –æ—Å–≤–æ–µ–Ω–∏—è</h3>
            <p style="margin:0 0 10px">{{ p }}% –æ—Ç –æ–±—â–µ–≥–æ —á–∏—Å–ª–∞ –º–∞—Ä—à—Ä—É—Ç–æ–≤</p>

            <div class="chips">
              <a class="btn" href="/index#choose"><i class="fa-solid fa-plus"></i> –î–æ–±–∞–≤–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç</a>
              <a class="btn ghost" href="/favourites"><i class="fa-solid fa-bookmark"></i> –ü–µ—Ä–µ–π—Ç–∏ –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ</a>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- –í–∫–ª–∞–¥–∫–∏ -->
    <section class="card" style="margin-top:12px">
      <div class="tabs" role="tablist">
        <button class="tab active" type="button" data-tab="routes" id="tab-routes">–ú–∞—Ä—à—Ä—É—Ç—ã</button>
        <button class="tab" type="button" data-tab="badges" id="tab-badges">–î–æ—Å—Ç–∏–∂–µ–Ω–∏—è</button>
        <button class="tab" type="button" data-tab="settings" id="tab-settings">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
      </div>

      <div class="panel active" id="panel-routes" role="tabpanel" aria-labelledby="tab-routes" style="margin-top:14px">
        <div id="popular-routes" class="mini-grid">
          {% if popular_routes %}
            {% for r in popular_routes %}
              <article class="mini-card" data-id="{{ r.id }}">
                <a class="route-link" href="/cul_dynamic/{{ r.id }}">
                  <img loading="lazy" src="{{ r.image_url or url_for('static', filename='img/placeholder.jpg') }}" alt="{{ r.title }}"/>
                  <div class="info">
                    <h3 class="route-title">{{ r.title }}</h3>
                    <div style="margin-top:8px;display:flex;gap:8px;align-items:center">
                      <span class="chip">‚òÖ {{ r.popularity or 0 }}</span>
                      <a href="/cul_dynamic/{{ r.id }}" class="btn ghost">–û—Ç–∫—Ä—ã—Ç—å</a>
                    </div>
                  </div>
                </a>
              </article>
            {% endfor %}
          {% else %}
            <!-- –§–æ–ª–ª–±–µ–∫: —Å–∫–µ–ª–µ—Ç–æ–Ω—ã -->
            {% for _ in range(6) %}
              <article class="mini-card"><div class="info"><h3>–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</h3><p class="text-slate-600">–ü–æ–¥–±–∏—Ä–∞–µ–º –º–∞—Ä—à—Ä—É—Ç—ã</p></div></article>
            {% endfor %}
          {% endif %}
        </div>
        <div class="text-right" style="margin-top:12px"><a class="btn" href="/favourites">–ü–µ—Ä–µ–π—Ç–∏ –≤ ¬´–ú–æ–∏ –º–∞—Ä—à—Ä—É—Ç—ã¬ª</a></div>
      </div>

      <div class="panel" id="panel-badges" role="tabpanel" aria-labelledby="tab-badges" style="margin-top:14px"> <role="tabpanel" aria-labelledby="tab-badges" style="margin-top:14px">
        <div class="mini-grid">
          <div class="mini-card"><div class="info"><h3>–ü–æ–∫–æ—Ä–∏—Ç–µ–ª—å –≥–æ—Ä</h3><p class="text-slate-600">5 –≥–æ—Ä–Ω—ã—Ö –º–∞—Ä—à—Ä—É—Ç–æ–≤ –∑–∞–≤–µ—Ä—à–µ–Ω–æ</p></div></div>
          <div class="mini-card"><div class="info"><h3>–•—Ä–æ–Ω–∏–∫—ë—Ä</h3><p class="text-slate-600">–ó–∞–≥—Ä—É–∂–µ–Ω–æ 50+ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π</p></div></div>
          <div class="mini-card"><div class="info"><h3>–ú–∞—Ä–∞—Ñ–æ–Ω–µ—Ü</h3><p class="text-slate-600">100 —á–∞—Å–æ–≤ –≤ –ø—É—Ç–∏</p></div></div>
        </div>
      </div>

      <div class="panel" id="panel-settings" role="tabpanel" aria-labelledby="tab-settings" style="margin-top:14px">
        <div class="mini-grid" style="grid-template-columns:1fr 1fr">
          <form class="card">
            <h3 style="margin:0 0 8px">–ü—Ä–æ—Ñ–∏–ª—å</h3>
            <label style="display:block;margin-bottom:10px"><span class="text-slate-600 text-sm">–ò–º—è</span><input class="input" type="text" value="{{ current_user.name }}" readonly></label>
            <label style="display:block;margin-bottom:10px"><span class="text-slate-600 text-sm">–§–∞–º–∏–ª–∏—è</span><input class="input" type="text" value="{{ current_user.surname }}" readonly></label>
            <label style="display:block;margin-bottom:10px"><span class="text-slate-600 text-sm">E‚Äëmail</span><input class="input" type="email" value="{{ current_user.email }}" readonly></label>
            <div class="text-right"><a href="/user_reg" class="btn ghost">–ò–∑–º–µ–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å</a></div>
          </form>
          <div class="card">
            <h3 style="margin:0 0 8px">–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è</h3>
            <p class="text-slate-600">–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–π—Ç–µ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ –º–µ–∂–¥—É —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º–∏. –í–∫–ª—é—á–∏—Ç–µ –≤—Ö–æ–¥ —Å –ø–æ—á—Ç–æ–π –∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º–∏.</p>
            <div style="margin-top:10px" class="chips">
              <a class="btn" href="/user_reg"><i class="fa-solid fa-shield-halved"></i> –í–æ–π—Ç–∏/–ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</a>
              <a class="btn ghost" href="/index"><i class="fa-solid fa-file-export"></i> –≠–∫—Å–ø–æ—Ä—Ç GPX</a>
            </div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <script>
    // ===== –ë—É—Ä–≥–µ—Ä/—Å–∞–π–¥–±–∞—Ä =====
    (function(){
      const burger=document.getElementById('burger-menu');
      const sidebar=document.getElementById('sidebar');
      const overlay=document.getElementById('overlay');
      function toggle(){burger.classList.toggle('active');sidebar.classList.toggle('active');overlay.classList.toggle('active');document.body.style.overflow=sidebar.classList.contains('active')?'hidden':''}
      burger.addEventListener('click',toggle); overlay.addEventListener('click',toggle);
    })();

    // ===== –í–∫–ª–∞–¥–∫–∏ (—É—Å—Ç–æ–π—á–∏–≤—ã–µ) =====
    (function(){
      const tabs=[...document.querySelectorAll('.tab')];
      const panels=[...document.querySelectorAll('.panel')];
      function activate(key){
        tabs.forEach(x=>x.classList.toggle('active', x.dataset.tab===key));
        panels.forEach(p=>p.classList.toggle('active', p.id===`panel-${key}`));
      }
      tabs.forEach(b=>{
        b.addEventListener('click', (e)=>{ e.preventDefault(); e.stopPropagation(); activate(b.dataset.tab); });
        // —Å—Ç—Ä–∞—Ö–æ–≤–∫–∞ –æ—Ç —Ç–∏–ø–∞ –∫–Ω–æ–ø–∫–∏
        if(!b.getAttribute('type')) b.setAttribute('type','button');
      });
      // –µ—Å–ª–∏ –≤ –∞–¥—Ä–µ—Å–µ –µ—Å—Ç—å #tab=routes/badges/settings ‚Äî —É—á—Ç—ë–º
      const m = location.hash.match(/tab=(routes|badges|settings)/);
      if(m) activate(m[1]);
    })();

    // ===== –ü–æ–ø—É–ª—è—Ä–Ω—ã–µ –º–∞—Ä—à—Ä—É—Ç—ã ‚Äî –∑–∞–≥—Ä—É–∑–∫–∞ —Å –±—ç–∫–∞, –µ—Å–ª–∏ Jinja –Ω–µ –∑–∞–ø–æ–ª–Ω–∏–ª =====
    (async function(){
      const wrap = document.getElementById('popular-routes');
      if(!wrap || wrap.querySelector('article')) return; // —Å–µ—Ä–≤–µ—Ä —É–∂–µ –æ—Ç–¥–∞–ª
      try{
        const res = await fetch('/api/popular_routes', {credentials:'include'});
        if(!res.ok) return;
        const data = await res.json();
        if(!Array.isArray(data)) return;
        wrap.innerHTML = data.slice(0,12).map(r=>`
          <article class="mini-card" data-id="${r.id}">
            <a class="route-link" href="/cul_dynamic/${r.id}">
              <img loading="lazy" src="${r.image_url || '/static/img/placeholder.jpg'}" alt="${r.title}"/>
              <div class="info">
                <h3 class="route-title">${r.title}</h3>
                <div style="margin-top:8px;display:flex;gap:8px;align-items:center">
                  <span class="chip">‚òÖ ${r.popularity || 0}</span>
                  <a href="/cul_dynamic/${r.id}" class="btn ghost">–û—Ç–∫—Ä—ã—Ç—å</a>
                </div>
              </div>
            </a>
          </article>`).join('');
      }catch(e){ /* —Ç–∏—Ö–æ —Ñ–µ–π–ª–∏–º */ }
    })();

    // ===== –ê–≤–∞—Ç–∞—Ä: –∑–∞–≥—Ä—É–∑–∫–∞ –±–µ–∑ –¥–≤–æ–π–Ω–æ–≥–æ –æ—Ç–∫—Ä—ã—Ç–∏—è =====
    (function(){
      const input=document.getElementById('avatar-input');
      const img=document.getElementById('avatar-img');
      const badge=document.getElementById('avatar-badge');
      const form=document.getElementById('avatar-form');
      if(!input||!img||!form) return; form.addEventListener('submit',e=>e.preventDefault());
      let lock=false; input.addEventListener('change',async function(){ if(lock||!this.files||!this.files[0]) return; const f=this.files[0]; if(!/^image\/(png|jpe?g|webp)$/i.test(f.type)){alert('–¢–æ–ª—å–∫–æ PNG/JPG/WEBP'); this.value=''; return;} if(f.size>6*1024*1024){alert('–§–∞–π–ª >6MB'); this.value=''; return;} const fd=new FormData(form); lock=true; img.style.opacity=.6; if(badge){badge.innerHTML='<i class="fa fa-spinner fa-spin"></i>'} try{ const res=await fetch('{{ url_for('upload_avatar') }}',{method:'POST',body:fd,credentials:'include'}); const data=await res.json(); if(data.success&&data.filename){ img.src='{{ url_for('static', filename='avatars/') }}'+data.filename+'?v='+Date.now(); } else { alert('–û—à–∏–±–∫–∞: '+(data.error||'–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å')); } } catch(e){ console.error(e); alert('–°–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω'); } finally { img.style.opacity=1; if(badge){badge.innerHTML='<i class="fa fa-camera"></i>'} this.value=''; lock=false; } });
    })();
  </script>
  <script>
  // ===== –ü—Ä–æ–≥—Ä–µ—Å—Å (JS) =====
  (function(){
    const root = document.querySelector('.progress'); if(!root) return;
    const r = 54, C = 2*Math.PI*r;
    // –≤—Ç–æ—Ä–æ–π <circle> ‚Äî —ç—Ç–æ –∞–∫—Ç–∏–≤–Ω–∞—è –¥—É–≥–∞
    const bar   = root.querySelector('svg circle:nth-of-type(2)');
    const label = root.querySelector('p');

    // 1) –ø—Ä–æ–±—É–µ–º –≤–∑—è—Ç—å –∏–∑ progress; 0‚Äì1 ‚Üí —É–º–Ω–æ–∂–∞–µ–º, 0‚Äì100 ‚Üí –æ—Å—Ç–∞–≤–ª—è–µ–º
    let raw = Number(root.dataset.progress);
    // 2) –µ—Å–ª–∏ progress –Ω–µ –∑–∞–¥–∞–Ω ‚Äî —Å—á–∏—Ç–∞–µ–º –∏–∑ completed / total
    const completed = Number(root.dataset.completed);
    const total     = Number(root.dataset.total);

    let p;
    if (!Number.isNaN(raw)) {
      p = Math.round(raw <= 1 ? raw*100 : raw);
    } else {
      p = (total > 0) ? Math.round(100*completed/total) : 0;
    }

    // –ø—Ä–∏–º–µ–Ω—è–µ–º –∫ –∫–æ–ª—å—Ü—É –∏ –ø–æ–¥–ø–∏—Å–∏
    bar.setAttribute('stroke-dasharray', `${(C*p)/100}, ${C}`);
    if (label) label.textContent = `${p}% –æ—Ç –æ–±—â–µ–≥–æ —á–∏—Å–ª–∞ –º–∞—Ä—à—Ä—É—Ç–æ–≤`;
  })();
</script>

</body>
</html>
