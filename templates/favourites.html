<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Избранные маршруты — Almaways</title>

  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;800&family=Playfair+Display:wght@700;800&display=swap" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"/>

  <style>
    :root{
      --bg:#F9FBFF; --panel:#FFFFFF; --ink:#0B1220; --muted:#566179;
      --primary:#B5CEF5; --secondary:#2E6D9C; --ring:#B5CEF5;
      --r-s:12px; --r-m:16px; --r-l:22px; --pill:999px;
      --s-s:0 6px 18px rgba(2,6,23,.06);
      --s-m:0 14px 34px rgba(2,6,23,.10);
      --s-l:0 24px 64px rgba(46,109,156,.22);
    }
    html,body{height:100%;background:var(--bg);color:var(--ink);font-family:'Poppins',system-ui,sans-serif;line-height:1.5;overflow-x:hidden}
    img{display:block;max-width:100%;height:auto}
    a{color:var(--secondary);text-decoration:none}
    .container{max-width:1200px;margin:0 auto;padding:0 16px}

    .btn{display:inline-flex;align-items:center;gap:.6rem;border:0;border-radius:var(--pill);padding:.75rem 1.1rem;font-weight:800;color:#fff;background:linear-gradient(180deg,var(--secondary),var(--primary));box-shadow:0 12px 26px rgba(46,109,156,.25);transition:.18s}
    .btn:hover{transform:translateY(-2px)}
    .btn.ghost{background:#fff;color:var(--secondary);border:1px solid var(--primary);box-shadow:var(--s-s)}
    .btn.danger{background:linear-gradient(180deg,#ef4444,#f59e0b)}
    .select,.input{background:#fff;border:1px solid #e6eef8;border-radius:14px;padding:12px 14px;color:var(--ink)}
    .input:focus,.select:focus{outline:2px solid var(--ring);box-shadow:0 0 0 3px rgba(46,109,156,.12)}

    /* Header & sidebar (как на других страницах) */
    .header{position:sticky;top:0;z-index:50;height:64px;display:flex;align-items:center;justify-content:space-between;padding:0 16px;background:rgba(255,255,255,.9);backdrop-filter:blur(12px);border-bottom:1px solid rgba(2,6,23,.06)}
    .brand{display:flex;align-items:center;gap:10px}
    .brand img{height:32px}
    .brand strong{color:var(--secondary)}
    .burger-menu{width:28px;height:20px;display:flex;flex-direction:column;justify-content:space-between;cursor:pointer}
    .burger-menu span{height:3px;background:var(--ink);border-radius:3px;transition:.25s}
    .burger-menu.active span:nth-child(1){transform:translateY(8px) rotate(45deg)}
    .burger-menu.active span:nth-child(2){opacity:0}
    .burger-menu.active span:nth-child(3){transform:translateY(-8px) rotate(-45deg)}

    .sidebar{position:fixed;inset:0 auto 0 0;width:320px;background:#fff;transform:translateX(-100%);transition:.3s;z-index:60;border-right:1px solid #e6eef8;box-shadow:var(--s-m);overflow:auto}
    .sidebar.active{transform:translateX(0)}
    .overlay{position:fixed;inset:0;background:rgba(11,18,32,.28);opacity:0;visibility:hidden;transition:.2s;z-index:55}
    .overlay.active{opacity:1;visibility:visible}
    .menu{display:flex;flex-direction:column;gap:6px;padding:8px 14px 18px}
    .menu a{display:flex;align-items:center;gap:.7rem;padding:10px 12px;border-radius:12px;color:var(--ink);transition:.2s}
    .menu a:hover{background:#f7faff}

    /* Hero */
    .hero{margin:16px 0;border-radius:22px;overflow:hidden;background:radial-gradient(800px 240px at 10% -10%, rgba(181,206,245,.28), transparent),linear-gradient(180deg,#fff,#f7fbff);box-shadow:var(--s-m)}
    .hero-inner{display:grid;grid-template-columns:1fr 520px;gap:18px;align-items:center;padding:18px}
    @media(max-width:980px){.hero-inner{grid-template-columns:1fr}}
    .hero h1{font-family:'Playfair Display',serif;font-size:clamp(1.6rem,3.5vw,2.4rem);margin:0}
    .hero p{margin:.4rem 0 0;color:#566179}
    .hero-art img{width:100%;border-radius:18px;aspect-ratio:16/9;object-fit:cover}

    /* Toolbar */
    .toolbar{display:flex;align-items:center;justify-content:space-between;gap:12px;margin:14px 0;flex-wrap:wrap}
    .searchbar{display:flex;gap:8px;align-items:center;flex:1}
    .searchbar .input{flex:1;min-width:clamp(180px,30vw,420px)}
    .toolbar .select{min-width:220px}

    /* Grid */
    #fav-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:18px}
    @media(max-width:1100px){ #fav-grid{grid-template-columns:repeat(2,1fr)}}
    @media(max-width:680px){ #fav-grid{grid-template-columns:1fr}}
    .card{position:relative;background:#fff;border:1px solid #e6eef8;border-radius:18px;overflow:hidden;box-shadow:var(--s-s);display:flex;flex-direction:column}
    .card img{width:100%;aspect-ratio:16/10;object-fit:cover}
    .card .info{padding:12px}
    .card .title{margin:0 0 6px}
    .meta{display:flex;flex-wrap:wrap;gap:8px;color:#64748b}
    .actions{display:flex;gap:8px;margin-top:10px}
    .heart{position:absolute;right:10px;top:10px;display:grid;place-items:center;width:42px;height:42px;border-radius:999px;background:rgba(255,255,255,.86);border:1px solid #e6eef8;box-shadow:var(--s-s);cursor:pointer}
    .heart i{color:#ef4444}

    .empty{display:grid;place-items:center;padding:36px;border:2px dashed #e6eef8;border-radius:18px;color:#64748b}
  </style>
</head>
<body>

<header class="header">
  <div class="burger-menu" id="burger-menu"><span></span><span></span><span></span></div>
  <div class="brand">
    <img src="{{ url_for('static', filename='img/logo.png') }}" alt="Logo"/>
    <strong>Almaways</strong>
  </div>
  <div class="hidden sm:flex items-center gap-2">
    <a href="/index" class="btn ghost" style="padding:.55rem 1rem">На главную</a>
    <a href="/cultural_routes" class="btn" style="padding:.55rem 1rem">К маршрутам</a>
  </div>
</header>

<aside class="sidebar" id="sidebar">
  <nav class="menu">
    <a href="/index"><i class="fas fa-home"></i>Главная</a>
    <a href="/cul/cultural_routes"><i class="fas fa-route"></i>Культурные маршруты</a>
    <a href="/favourites" class="active"><i class="fas fa-heart"></i>Избранное</a>
    <a href="/user_office"><i class="fas fa-user"></i>Личный кабинет</a>
    <a href="/logout"><i class="fas fa-sign-out-alt"></i>Выход</a>
  </nav>
</aside>
<div class="overlay" id="overlay"></div>

<main class="container" style="padding:18px 0 28px">
  <!-- Hero -->
  <section class="hero">
    <div class="hero-inner">
      <div>
        <h1>Избранные маршруты</h1>
        <p>Твои сохранённые треки, прогулки и культурные подборки. Ищи, сортируй и начинай приключение в один клик.</p>
        <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
          <a class="btn" href="/cul/cultural_routes"><i class="fa-solid fa-compass"></i> Найти новые</a>
          <a class="btn ghost" href="/user_office"><i class="fa-solid fa-user"></i> Личный кабинет</a>
        </div>
      </div>
      <div class="hero-art">
        <img src="{{ url_for('static', filename='img/culture_hero.jpg') }}" alt="Favourite routes" onerror="this.style.display='none'">
      </div>
    </div>
  </section>

  <!-- Toolbar -->
  <div class="toolbar">
    <div class="searchbar">
      <i class="fa-solid fa-magnifying-glass" aria-hidden="true"></i>
      <input id="q" class="input" type="search" placeholder="Поиск по названию и описанию…" autocomplete="off">
    </div>
    <select id="sort" class="select" aria-label="Сортировка">
      <option value="popular">Сначала популярные/рейтинг</option>
      <option value="new">Сначала новые</option>
      <option value="length_asc">По длине (короче →)</option>
      <option value="length_desc">По длине (длиннее →)</option>
      <option value="dur_asc">По длительности (быстрее →)</option>
      <option value="dur_desc">По длительности (дольше →)</option>
    </select>
    <button id="clearAll" class="btn danger" type="button" title="Очистить избранное"><i class="fa-regular fa-heart"></i> Очистить</button>
  </div>

  <!-- GRID -->
  <section id="fav-grid" aria-live="polite">
    {% if routes and routes|length %}
      {% for r in routes %}
        {% set title = (r.title or r.name or 'Маршрут') %}
        {% set desc  = (r.short_description if r.short_description is not none else (r.description if r.description is not none else '')) %}
        {% set img   = r.image_url or r.img or url_for('static', filename='img/placeholder.jpg') %}
        {% set rating = r.rating if r.rating is not none else (r.popularity if r.popularity is not none else 0) %}
        {% set length = r.length_km if r.length_km is not none else (r.length if r.length is not none else 0) %}
        {% set dur = r.duration if r.duration is not none else (r.duration_hours if r.duration_hours is not none else 0) %}
        <article class="card"
                 data-id="{{ r.id }}"
                 data-title="{{ title|e }}"
                 data-desc="{{ desc|e }}"
                 data-rating="{{ rating }}"
                 data-length="{{ length }}"
                 data-duration="{{ dur }}">
          <button class="heart fav-btn" data-id="{{ r.id }}" title="Убрать из избранного">
            <i class="fa-solid fa-heart"></i>
          </button>
          <img loading="lazy" src="{{ img }}" alt="{{ title }}">
          <div class="info">
            <h3 class="title">{{ title }}</h3>
            <div class="meta">
              <span>★ {{ rating }}</span>
              {% if r.category is defined and r.category %}<span>#{{ r.category }}</span>{% endif %}
              {% if r.difficulty is defined and r.difficulty %}<span>{{ r.difficulty }}</span>{% endif %}
              {% if dur %}<span><i class="fa-regular fa-clock"></i> {{ dur }}</span>{% endif %}
              {% if length %}<span><i class="fa-solid fa-person-hiking"></i> {{ length }} км</span>{% endif %}
            </div>
            {% if desc %}<p style="margin:8px 0 0;color:#64748b">{{ desc|truncate(160) }}</p>{% endif %}
            <div class="actions">
              <a href="/cul/{{ r.id }}" class="btn ghost">Открыть</a>
              <a href="/cul/{{ r.id }}#map" class="btn"><i class="fa-regular fa-map"></i> Карта</a>
            </div>
          </div>
        </article>
      {% endfor %}
    {% else %}
      <div class="empty">
        <div style="text-align:center">
          <h3 style="margin:0 0 6px">Пока пусто</h3>
          <p>Добавляй маршруты в избранное со страницы «Культурные маршруты».</p>
          <div style="margin-top:10px"><a class="btn" href="/cultural_routes"><i class="fa-solid fa-compass"></i> Перейти к маршрутам</a></div>
        </div>
      </div>
    {% endif %}
  </section>
</main>

<script>
  // ===== Бургер/сайдбар =====
  (function(){
    const b=document.getElementById('burger-menu'), s=document.getElementById('sidebar'), o=document.getElementById('overlay');
    function t(){b.classList.toggle('active');s.classList.toggle('active');o.classList.toggle('active');document.body.style.overflow=s.classList.contains('active')?'hidden':''}
    b?.addEventListener('click',t); o?.addEventListener('click',t);
  })();

  // ===== Утилиты =====
  function debounce(fn, d){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn.apply(null,a), d); }; }
  function norm(s){ return (s||'').toString().toLowerCase(); }
  function toNum(v){ let x=parseFloat(v); return isNaN(x)?0:x; }

  const grid  = document.getElementById('fav-grid');
  const q     = document.getElementById('q');
  const sort  = document.getElementById('sort');
  const clear = document.getElementById('clearAll');

  // ===== Фильтр по вводу (клиентский) =====
  function applyFilter(){
    const term = norm(q?.value||'');
    const cards = grid.querySelectorAll('.card');
    let visible = 0;
    cards.forEach(c=>{
      const text = norm(c.dataset.title + ' ' + c.dataset.desc);
      const show = term==='' || text.indexOf(term) !== -1;
      c.style.display = show ? '' : 'none';
      if(show) visible++;
    });
    if(visible===0 && !grid.querySelector('.empty')){
      const empty = document.createElement('div');
      empty.className='empty';
      empty.innerHTML = '<div style="text-align:center"><h3 style="margin:0 0 6px">Ничего не найдено</h3><p>Попробуй изменить запрос.</p></div>';
      grid.appendChild(empty);
    } else {
      const e = grid.querySelector('.empty'); if(e) e.remove();
    }
  }
  const debouncedFilter = debounce(applyFilter, 250);
  q?.addEventListener('input', debouncedFilter);
  q?.addEventListener('keydown', e=>{ if(e.key==='Escape'){ q.value=''; debouncedFilter(); } });

  // ===== Сортировка (клиентская) =====
  function applySort(){
    const mode = sort?.value || 'popular';
    const cards = Array.from(grid.querySelectorAll('.card'));
    const vis = cards.filter(c=>c.style.display!=='none');
    const by = {
      popular: (a,b)=> toNum(b.dataset.rating) - toNum(a.dataset.rating),
      new:     (a,b)=> toNum(b.dataset.id) - toNum(a.dataset.id),
      length_asc:  (a,b)=> toNum(a.dataset.length) - toNum(b.dataset.length),
      length_desc: (a,b)=> toNum(b.dataset.length) - toNum(a.dataset.length),
      dur_asc:     (a,b)=> toNum(a.dataset.duration) - toNum(b.dataset.duration),
      dur_desc:    (a,b)=> toNum(b.dataset.duration) - toNum(a.dataset.duration),
    }[mode] || ((a,b)=>0);

    vis.sort(by).forEach(el=>grid.appendChild(el));
  }
  sort?.addEventListener('change', ()=>{ applySort(); });

  // ===== Удаление из избранного =====
  async function toggleFav(id, state){
    const key = `cul_${id}_fav`;
    const res = await fetch('/update_route_state_fav', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      credentials:'include',
      body: JSON.stringify({route_id:key, new_state_fav: state})
    });
    const data = await res.json().catch(()=>({}));
    if(!res.ok || !data.status || data.status!=='success'){
      throw new Error(data.message || 'Ошибка');
    }
  }

  grid?.addEventListener('click', async (e)=>{
    const btn = e.target.closest('.fav-btn'); if(!btn) return;
    e.preventDefault();
    const id = btn.dataset.id;
    try{
      await toggleFav(id, false); // снять из избранного
      const card = btn.closest('.card'); if(card) card.remove();
      applyFilter(); // пересчитать "пусто"
    }catch(err){
      alert('Не удалось обновить избранное: ' + err.message);
    }
  });

  // ===== Очистить всё =====
  clear?.addEventListener('click', async ()=>{
    const cards = Array.from(grid.querySelectorAll('.card'));
    if(!cards.length) return;
    if(!confirm('Убрать все маршруты из избранного?')) return;

    for(const c of cards){
      const id = c.dataset.id;
      try{ await toggleFav(id, false); c.remove(); }
      catch(err){ console.error('fav clear error', id, err); }
    }
    applyFilter();
  });

  // стартовая сортировка
  applySort();
</script>
</body>
</html>
