<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Культурные маршруты — Almaways</title>

  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;800&family=Playfair+Display:wght@700;800&display=swap" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"/>

  <style>
    :root{
      --bg:#F9FBFF; --panel:#FFFFFF; --ink:#0B1220; --muted:#566179;
      --primary:#B5CEF5; --secondary:#2E6D9C; --ring:#B5CEF5;
      --r-s:12px; --r-m:16px; --r-l:22px; --pill:999px;
      --s-s:0 6px 18px rgba(2,6,23,.06);
      --s-m:0 14px 34px rgba(2,6,23,.10);
      --s-l:0 24px 64px rgba(46,109,156,.22);
    }
    html,body{height:100%;background:var(--bg);color:var(--ink);font-family:'Poppins',system-ui,sans-serif;line-height:1.5;overflow-x:hidden}
    img{display:block;max-width:100%;height:auto}
    a{color:var(--secondary);text-decoration:none}
    .container{max-width:1200px;margin:0 auto;padding:0 16px}

    .btn{display:inline-flex;align-items:center;gap:.6rem;border:0;border-radius:var(--pill);padding:.75rem 1.1rem;font-weight:800;color:#fff;background:linear-gradient(180deg,var(--secondary),var(--primary));box-shadow:0 12px 26px rgba(46,109,156,.25);transition:.18s}
    .btn:hover{transform:translateY(-2px)}
    .btn.ghost{background:#fff;color:var(--secondary);border:1px solid var(--primary);box-shadow:var(--s-s)}
    .input,.select{width:100%;background:var(--panel);border:1px solid #e6eef8;border-radius:14px;padding:12px 14px;color:var(--ink)}
    .input:focus,.select:focus{outline:2px solid var(--ring);box-shadow:0 0 0 3px rgba(46,109,156,.12)}
    .chip{display:inline-flex;align-items:center;gap:.35rem;border-radius:var(--pill);padding:.25rem .65rem;background:#EAF2FE;color:#2E6D9C;font-weight:700;font-size:.82rem}

    /* Header (как на других страницах) */
    .header{position:sticky;top:0;z-index:50;height:64px;display:flex;align-items:center;justify-content:space-between;padding:0 16px;background:rgba(255,255,255,.9);backdrop-filter:blur(12px);border-bottom:1px solid rgba(2,6,23,.06)}
    .brand{display:flex;align-items:center;gap:10px}
    .brand img{height:32px}
    .brand strong{color:var(--secondary)}
    .burger-menu{width:28px;height:20px;display:flex;flex-direction:column;justify-content:space-between;cursor:pointer}
    .burger-menu span{height:3px;background:var(--ink);border-radius:3px;transition:.25s}
    .burger-menu.active span:nth-child(1){transform:translateY(8px) rotate(45deg)}
    .burger-menu.active span:nth-child(2){opacity:0}
    .burger-menu.active span:nth-child(3){transform:translateY(-8px) rotate(-45deg)}
    .sidebar{position:fixed;inset:0 auto 0 0;width:320px;background:#fff;transform:translateX(-100%);transition:.3s;z-index:60;border-right:1px solid #e6eef8;box-shadow:var(--s-m);overflow:auto}
    .sidebar.active{transform:translateX(0)}
    .overlay{position:fixed;inset:0;background:rgba(11,18,32,.28);opacity:0;visibility:hidden;transition:.2s;z-index:55}
    .overlay.active{opacity:1;visibility:visible}
    .menu{display:flex;flex-direction:column;gap:6px;padding:8px 14px 18px}
    .menu a{display:flex;align-items:center;gap:.7rem;padding:10px 12px;border-radius:12px;color:var(--ink);transition:.2s}
    .menu a:hover{background:#f7faff}

    /* Hero */
    .hero{margin:16px 0;border-radius:22px;overflow:hidden;background:radial-gradient(800px 240px at 10% -10%, rgba(181,206,245,.28), transparent),linear-gradient(180deg,#fff,#f7fbff);box-shadow:var(--s-m)}
    .hero-inner{display:grid;grid-template-columns:1fr 520px;gap:18px;align-items:center;padding:18px}
    @media(max-width:980px){.hero-inner{grid-template-columns:1fr}}
    .hero h1{font-family:'Playfair Display',serif;font-size:clamp(1.6rem,3.5vw,2.4rem);margin:0}
    .hero p{margin:.4rem 0 0;color:#566179}
    .hero-art{position:relative}
    .hero-art img{width:100%;border-radius:18px;aspect-ratio:16/9;object-fit:cover}
    .hero-badges{position:absolute;left:12px;bottom:12px;display:flex;gap:8px}

    /* Toolbar */
    .toolbar{display:flex;align-items:center;justify-content:space-between;gap:12px;margin:14px 0}
    .toolbar-actions{display:flex;gap:8px;align-items:center;flex-wrap:wrap}

    /* Drawer (filters) */
    .filters-overlay{position:fixed;inset:0;background:rgba(11,18,32,.35);backdrop-filter:blur(2px);z-index:70;opacity:0;visibility:hidden;transition:.2s}
    .filters-overlay.active{opacity:1;visibility:visible}
    .filters-drawer{position:fixed;top:0;right:0;bottom:0;width:min(92vw,420px);background:#fff;border-left:1px solid #e6eef8;box-shadow:var(--s-l);transform:translateX(100%);transition:.28s;z-index:80;display:flex;flex-direction:column}
    .filters-drawer.active{transform:translateX(0)}
    .filters-head{position:sticky;top:0;background:#fff;border-bottom:1px solid #e6eef8;padding:12px 16px;display:flex;align-items:center;justify-content:space-between}
    .filters-body{padding:14px 16px;display:grid;gap:12px;overflow:auto}
    .filters-foot{padding:12px 16px;border-top:1px solid #e6eef8;display:flex;gap:8px;justify-content:flex-end}
    .block{display:block}
    .block.two{display:grid;grid-template-columns:1fr;gap:12px}
    @media(min-width:640px){.block.two{grid-template-columns:1fr 1fr}}
    .lbl{display:block;margin:0 0 6px;color:#566179;font-size:.9rem}
    .tags{display:flex;gap:8px;flex-wrap:wrap}
    .tag{border:1px solid #e6eef8;background:#fff;border-radius:999px;padding:.45rem .8rem;cursor:pointer;transition:.15s}
    .tag.active{background:var(--secondary);color:#fff;border-color:var(--secondary)}
    .range{display:flex;gap:8px}

    /* Grid */
    #routes-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:18px}
    @media(max-width:1100px){ #routes-grid{grid-template-columns:repeat(2,1fr)}}
    @media(max-width:680px){ #routes-grid{grid-template-columns:1fr}}
    .card{background:#fff;border:1px solid #e6eef8;border-radius:18px;overflow:hidden;box-shadow:var(--s-s);display:flex;flex-direction:column}
    .card img{width:100%;aspect-ratio:16/10;object-fit:cover}
    .card .info{padding:12px}
    .card .title{margin:0 0 6px}
    .card .meta{display:flex;flex-wrap:wrap;gap:8px;color:#64748b}
    .card .actions{display:flex;gap:8px;margin-top:10px}
    .cover-link{display:block;line-height:0}

    /* Admin quick tools (card) */
    .adm-tools{position:absolute;inset:auto 8px 8px auto;display:flex;gap:6px}
    .adm-btn{background:#fff;border:1px solid #e6eef8;border-radius:10px;padding:.35rem .55rem;box-shadow:var(--s-s)}

    /* Admin drawer */
    .admin-fab{position:fixed;right:16px;bottom:16px;z-index:90}
    .admin-panel{position:fixed;right:0;top:0;bottom:0;width:min(92vw,480px);background:#fff;border-left:1px solid #e6eef8;box-shadow:var(--s-l);transform:translateX(100%);transition:.28s;z-index:95;display:flex;flex-direction:column}
    .admin-panel.active{transform:translateX(0)}
    .admin-head{position:sticky;top:0;background:#fff;border-bottom:1px solid #e6eef8;padding:12px 16px;display:flex;align-items:center;justify-content:space-between}
    .admin-body{padding:14px 16px;display:grid;gap:12px;overflow:auto}

    /* Pager */
    .pager{display:flex;gap:12px;align-items:center;justify-content:center;margin:18px 0}
    .pager .current{color:#64748b}
    .searchbar{display:flex;align-items:center;gap:8px;flex:1}
.searchbar .input{min-width:clamp(160px,28vw,360px)}
@media (max-width:700px){
  .toolbar{flex-direction:column;align-items:stretch}
  .toolbar-actions{width:100%;justify-content:space-between}
  .searchbar{width:100%}
  .searchbar .input{flex:1;min-width:0}
}
/* не даём Jinja споткнуться на "{ #": всегда пробел после "{" перед #id */
@media (max-width:1100px) { #routes-grid { grid-template-columns: repeat(2,1fr); } }
@media (max-width:680px)  { #routes-grid { grid-template-columns: 1fr; } }
  </style>
</head>
<body>

<header class="header">
  <div class="burger-menu" id="burger-menu"><span></span><span></span><span></span></div>
  <div class="brand">
    <img src="{{ url_for('static', filename='img/logo.png') }}" alt="Logo"/>
    <strong>Almaways</strong>
  </div>
  <div class="hidden sm:flex items-center gap-2">
    <a href="/index" class="btn ghost" style="padding:.55rem 1rem">На главную</a>
    <a href="/favourites" class="btn" style="padding:.55rem 1rem">Избранное</a>
  </div>
</header>
<aside class="sidebar" id="sidebar">
  <nav class="menu">
    <a href="/index"><i class="fas fa-home"></i>Главная</a>
    <a href="/cul/cultural_routes" class="active"><i class="fas fa-route"></i>Культурные маршруты</a>
    <a href="/favourites"><i class="fas fa-heart"></i>Избранное</a>
    <a href="/user_office"><i class="fas fa-user"></i>Личный кабинет</a>
    <a href="/logout"><i class="fas fa-sign-out-alt"></i>Выход</a>
  </nav>
</aside>
<div class="overlay" id="overlay"></div>

<main class="container" style="padding:18px 0 28px">
  <!-- Hero -->
  <section class="hero">
    <div class="hero-inner">
      <div>
        <h1>Культурные маршруты</h1>
        <p>Выбирай из лучших подборок: музеи, рынки, архитектура, стрит-арт и гастрономия. Умные фильтры помогут найти идеальный маршрут.</p>
        <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
          <a class="btn" href="/favourites"><i class="fa-solid fa-heart"></i> Избранное</a>
          <a class="btn ghost" href="/index#choose"><i class="fa-solid fa-compass"></i> Обзор</a>
        </div>
      </div>
      <div class="hero-art">
        <img src="{{ url_for('static', filename='img/culture_hero.jpg') }}" alt="Almaways Culture" onerror="this.style.display='none'">
        {% if current_user.is_authenticated and current_user.is_admin %}
          <div class="hero-badges"><span class="chip">Админ-режим</span></div>
        {% endif %}
      </div>
    </div>
  </section>

  <!-- Toolbar -->
  <div class="toolbar">
  <h2 style="margin:0">Подборка</h2>
  <div class="toolbar-actions">
    <div class="searchbar">
      <input id="q_top" class="input" type="search"
             placeholder="Название, описание…"
             value="{{ request.args.get('q','') }}" autocomplete="off">
    </div>

    <button id="open-filters" class="btn ghost" type="button">
      <i class="fa-solid fa-sliders"></i> Фильтры
    </button>

    <select id="f_sort" class="select" aria-label="Сортировка">
      {% set s = request.args.get('sort','popular') %}
      <option value="popular" {{ 'selected' if s=='popular' else '' }}>Сначала популярные</option>
      <option value="rating"  {{ 'selected' if s=='rating' else '' }}>По рейтингу</option>
      <option value="new"     {{ 'selected' if s=='new' else '' }}>Сначала новые</option>
      <option value="length_asc"  {{ 'selected' if s=='length_asc' else '' }}>По длине (короче →)</option>
      <option value="length_desc" {{ 'selected' if s=='length_desc' else '' }}>По длине (длиннее →)</option>
    </select>
  </div>
</div>



  <!-- FILTER DRAWER -->
  <div id="filters-overlay" class="filters-overlay" hidden></div>
  <aside id="filters-drawer" class="filters-drawer" aria-hidden="true" aria-labelledby="filters-title">
    <div class="filters-head">
      <h3 id="filters-title" style="margin:0">Фильтры</h3>
      <button id="close-filters" class="btn ghost" type="button">Закрыть</button>
    </div>
    <div class="filters-body">
      

      <div class="block">
        <span class="lbl">Категории</span>
        <div id="f_cats" class="tags">
          {% set ac = request.args.getlist('cat') %}
          {% for c in (categories or []) %}
            <button type="button" class="tag {{ 'active' if c in ac else '' }}" data-key="cat" data-val="{{ c }}">{{ c }}</button>
          {% endfor %}
        </div>
      </div>

      <div class="block">
        <span class="lbl">Сложность</span>
        <div id="f_diff" class="tags">
          {% set ad = request.args.getlist('diff') %}
          {% for d in ['easy','medium','hard'] %}
            <button type="button" class="tag {{ 'active' if d in ad else '' }}" data-key="diff" data-val="{{ d }}">{{ d }}</button>
          {% endfor %}
        </div>
      </div>

      <div class="block two">
        <label>
          <span class="lbl">Длительность, ч (от–до)</span>
          <div class="range">
            <input id="f_dmin" type="number" min="0" step="0.5" class="input" placeholder="от" value="{{ request.args.get('dmin','') }}" />
            <input id="f_dmax" type="number" min="0" step="0.5" class="input" placeholder="до" value="{{ request.args.get('dmax','') }}" />
          </div>
        </label>
        <label>
          <span class="lbl">Длина, км (от–до)</span>
          <div class="range">
            <input id="f_lmin" type="number" min="0" step="0.1" class="input" placeholder="от" value="{{ request.args.get('lmin','') }}" />
            <input id="f_lmax" type="number" min="0" step="0.1" class="input" placeholder="до" value="{{ request.args.get('lmax','') }}" />
          </div>
        </label>
      </div>

      <label class="block">
        <span class="lbl">Рейтинг ≥</span>
        <input id="f_rmin" type="number" min="0" max="5" step="0.1" class="input" placeholder="0–5" value="{{ request.args.get('rmin','') }}" />
      </label>
    </div>
    <div class="filters-foot">
      <button id="f_reset" class="btn ghost" type="button">Сброс</button>
      <button id="f_apply" class="btn" type="button"><i class="fa-solid fa-filter"></i> Применить</button>
    </div>
  </aside>

  <!-- GRID -->
  <section id="routes-grid">
    {% if routes and routes|length %}
      {% for r in routes %}
        <article class="card" data-id="{{ r.id }}">
          <div style="position:relative">
            <a href="/cul_dynamic/{{ r.id }}" class="cover-link" aria-label="Открыть {{ r.title or r.name }}">
              <img loading="lazy" src="{{ r.image_url or r.img or url_for('static', filename='img/placeholder.jpg') }}" alt="{{ r.title or r.name }}"/>
            </a>
            {% if current_user.is_authenticated and current_user.is_admin %}
              <div class="adm-tools">
                <button class="adm-btn" data-adm="edit" data-id="{{ r.id }}" title="Редактировать"><i class="fa-regular fa-pen-to-square"></i></button>
                <button class="adm-btn" data-adm="publish" data-id="{{ r.id }}" title="Вкл/выкл публикацию"><i class="fa-solid fa-toggle-on"></i></button>
                <button class="adm-btn" data-adm="delete" data-id="{{ r.id }}" title="Удалить"><i class="fa-regular fa-trash-can"></i></button>
              </div>
            {% endif %}
          </div>
          <div class="info">
            <h3 class="title">{{ r.title or r.name }}</h3>
            <div class="meta">
              <span>★ {{ r.rating if r.rating is defined else (r.popularity if r.popularity is defined else 0) }}</span>
              {% if r.category is defined and r.category %}<span>#{{ r.category }}</span>{% endif %}
              {% if r.difficulty is defined and r.difficulty %}<span>{{ r.difficulty }}</span>{% endif %}
              {% if r.duration is defined and r.duration %}<span><i class="fa-regular fa-clock"></i> {{ r.duration }}</span>{% endif %}
              {% if r.length_km is defined and r.length_km %}<span><i class="fa-solid fa-person-hiking"></i> {{ r.length_km }} км</span>{% endif %}
            </div>
            {% if r.short_description is defined and r.short_description %}
              <p style="margin:8px 0 0;color:#64748b">{{ r.short_description }}</p>
            {% endif %}
            <div class="actions">
              <a href="/cul_dynamic/{{ r.id }}" class="btn ghost">Открыть</a>
              <a href="/add_to_favourites/{{ r.id }}" class="btn" aria-label="Добавить в избранное"><i class="fa-regular fa-bookmark"></i></a>
            </div>
          </div>
        </article>
      {% endfor %}
    {% else %}
      {% for _ in range(6) %}
        <article class="card">
          <div class="info">
            <h3 class="title">Маршрутов не найдено</h3>
            <p style="color:#64748b">Измени фильтры (кнопка «Фильтры») и попробуй ещё раз.</p>
          </div>
        </article>
      {% endfor %}
    {% endif %}
  </section>

  <!-- PAGINATION -->
  {% if page is defined and pages is defined and pages > 1 %}
  <nav class="pager" aria-label="Пагинация">
    {% set prev = page-1 %}{% set next = page+1 %}
    {% if prev >= 1 %}
      <a href="#" class="pager-link" data-page="{{ prev }}">Назад</a>
    {% else %}
      <span>Назад</span>
    {% endif %}
    <span class="current">{{ page }} / {{ pages }}</span>
    {% if next <= pages %}
      <a href="#" class="pager-link" data-page="{{ next }}">Вперёд</a>
    {% else %}
      <span>Вперёд</span>
    {% endif %}
  </nav>
  {% endif %}

</main>

{% if current_user.is_authenticated and current_user.is_admin %}
<!-- ADMIN FAB + PANEL -->
<div class="admin-fab"><button id="adm_open" class="btn"><i class="fa-solid fa-wand-magic-sparkles"></i> Админ-панель</button></div>
<aside id="adm_panel" class="admin-panel" aria-label="Админ-панель">
  <div class="admin-head">
    <strong>Редактор маршрута</strong>
    <button id="adm_close" class="btn ghost" type="button">Закрыть</button>
  </div>
  <div class="admin-body">
    <form id="adm_form" enctype="multipart/form-data">
      <input type="hidden" name="id" id="adm_id"/>
      <label class="block">
        <span class="lbl">Название</span>
        <input class="input" name="title" id="adm_title" required>
      </label>

      <div class="block two">
        <label>
          <span class="lbl">Категория</span>
          <input class="input" name="category" list="cats_list" id="adm_category">
        </label>
        <label>
          <span class="lbl">Сложность</span>
          <select class="select" name="difficulty" id="adm_difficulty">
            <option value="">—</option><option>easy</option><option>medium</option><option>hard</option>
          </select>
        </label>
      </div>

      <div class="block two">
        <label>
          <span class="lbl">Длительность (ч)</span>
          <input class="input" name="duration" type="number" step="0.5" min="0" id="adm_duration">
        </label>
        <label>
          <span class="lbl">Длина (км)</span>
          <input class="input" name="length_km" type="number" step="0.1" min="0" id="adm_length">
        </label>
      </div>

      <label class="block">
        <span class="lbl">Рейтинг (0–5)</span>
        <input class="input" name="rating" type="number" step="0.1" min="0" max="5" id="adm_rating">
      </label>

      <label class="block">
        <span class="lbl">Короткое описание</span>
        <textarea class="input" name="short_description" rows="3" id="adm_desc"></textarea>
      </label>

      <label class="block">
        <span class="lbl">Обложка (png/jpg/webp)</span>
        <input class="input" name="image" type="file" accept="image/png, image/jpeg, image/webp" id="adm_image">
      </label>

      <div style="display:flex;gap:8px;justify-content:flex-end">
        <button id="adm_save" class="btn" type="submit"><i class="fa-regular fa-floppy-disk"></i> Сохранить</button>
        <button id="adm_new" class="btn ghost" type="button">Новый</button>
      </div>
    </form>
    <datalist id="cats_list">
      {% for c in (categories or []) %}
        <option value="{{ c }}"></option>
      {% endfor %}
    </datalist>
  </div>
</aside>
{% endif %}

<script>
(function(){
  // ---- ЕДИНЫЙ AJAX ДЛЯ ПОИСКА/ФИЛЬТРОВ/ПАГИНАЦИИ ----
  var API = "{{ url_for('cultural_routes_json') }}"; // <-- правильный JSON-роут

  var grid = document.getElementById('routes-grid');
  var qTop = document.getElementById('q_top');
  var sort = document.getElementById('f_sort');
  var dmin = document.getElementById('f_dmin'), dmax = document.getElementById('f_dmax');
  var lmin = document.getElementById('f_lmin'), lmax = document.getElementById('f_lmax');
  var rmin = document.getElementById('f_rmin');
  var cats = document.getElementById('f_cats');
  var diff = document.getElementById('f_diff');

  function activeTags(container){
    if(!container) return [];
    var out=[], tags=container.querySelectorAll('.tag.active');
    for(var i=0;i<tags.length;i++) out.push(tags[i].getAttribute('data-val'));
    return out;
  }
  function buildParams(extra){
    var p = new URLSearchParams();
    var qv = qTop && qTop.value ? qTop.value.trim() : '';
    if(qv) p.set('q', qv);
    if(sort && sort.value) p.set('sort', sort.value);

    var ac = activeTags(cats); for(var i=0;i<ac.length;i++) p.append('cat', ac[i]);
    var ad = activeTags(diff); for(var j=0;j<ad.length;j++) p.append('diff', ad[j]);

    if(dmin && dmin.value) p.set('dmin', dmin.value);
    if(dmax && dmax.value) p.set('dmax', dmax.value);
    if(lmin && lmin.value) p.set('lmin', lmin.value);
    if(lmax && lmax.value) p.set('lmax', lmax.value);
    if(rmin && rmin.value) p.set('rmin', rmin.value);

    if(extra){
      for(var k in extra) if(Object.prototype.hasOwnProperty.call(extra,k)) p.set(k, extra[k]);
    }
    return p;
  }
  function esc(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;'); }
  function cardHTML(r, isAdmin){
    var img = r.image_url || "{{ url_for('static', filename='img/placeholder.jpg') }}";
    var title = esc(r.title);
    var desc = r.short_description ? '<p style="margin:8px 0 0;color:#64748b">'+esc(r.short_description)+'</p>' : '';
    var cat  = r.category ? '<span>#'+esc(r.category)+'</span>' : '';
    var dif  = r.difficulty ? '<span>'+esc(r.difficulty)+'</span>' : '';
    var dur  = r.duration ? '<span><i class="fa-regular fa-clock"></i> '+esc(r.duration)+'</span>' : '';
    var len  = (r.length_km || r.length_km===0) ? '<span><i class="fa-solid fa-person-hiking"></i> '+esc(r.length_km)+' км</span>' : '';
    var rating = (r.rating != null) ? r.rating : 0;
    var adm  = isAdmin ? (
      '<div class="adm-tools">'+
      ' <button class="adm-btn" data-adm="edit" data-id="'+r.id+'" title="Редактировать"><i class="fa-regular fa-pen-to-square"></i></button>'+
      ' <button class="adm-btn" data-adm="publish" data-id="'+r.id+'" title="Вкл/выкл публикацию"><i class="fa-solid fa-toggle-on"></i></button>'+
      ' <button class="adm-btn" data-adm="delete" data-id="'+r.id+'" title="Удалить"><i class="fa-regular fa-trash-can"></i></button>'+
      '</div>'
    ) : '';

    return ''+
    '<article class="card" data-id="'+r.id+'">'+
      '<div style="position:relative">'+
        '<a href="/cul_dynamic/'+r.id+'" class="cover-link" aria-label="Открыть '+title+'">'+
          '<img loading="lazy" src="'+img+'" alt="'+title+'"/>'+
        '</a>'+adm+
      '</div>'+
      '<div class="info">'+
        '<h3 class="title">'+title+'</h3>'+
        '<div class="meta">'+
          '<span>★ '+rating+'</span>'+cat+dif+dur+len+
        '</div>'+desc+
        '<div class="actions">'+
          '<a href="/cul_dynamic/'+r.id+'" class="btn ghost">Открыть</a>'+
          '<a href="/add_to_favourites/'+r.id+'" class="btn" aria-label="Добавить в избранное"><i class="fa-regular fa-bookmark"></i></a>'+
        '</div>'+
      '</div>'+
    '</article>';
  }
  function renderPager(page, pages){
    var pager = document.querySelector('.pager');
    if(!pager){ pager=document.createElement('nav'); pager.className='pager'; grid.after(pager); }
    var prev = (page>1)? '<a href="#" class="pager-link" data-page="'+(page-1)+'">Назад</a>' : '<span>Назад</span>';
    var next = (page<pages)? '<a href="#" class="pager-link" data-page="'+(page+1)+'">Вперёд</a>' : '<span>Вперёд</span>';
    pager.innerHTML = prev+'<span class="current">'+page+' / '+pages+'</span>'+next;
    var links = pager.querySelectorAll('.pager-link');
    for(var i=0;i<links.length;i++){
      links[i].addEventListener('click', function(e){ e.preventDefault(); fetchAndRender({page:this.getAttribute('data-page')}, true); });
    }
  }
  function setLoading(on){ if(grid) grid.style.opacity = on ? '0.6' : ''; }

  function fetchAndRender(extra, push){
    setLoading(true);
    var params = buildParams(extra);
    var url = API + '?' + params.toString();
    return fetch(url, {credentials:'include'})
      .then(function(res){
        var ct = res.headers.get('content-type')||'';
        if(ct.indexOf('application/json')===-1) throw new Error('Не JSON');
        return res.json();
      })
      .then(function(data){
        var html='', items=(data&&data.items)||[];
        if(items.length){
          for(var i=0;i<items.length;i++){ html += cardHTML(items[i], !!data.is_admin); }
        }else{
          for(var j=0;j<6;j++){
            html += '<article class="card"><div class="info"><h3 class="title">Маршрутов не найдено</h3><p style="color:#64748b">Измени фильтры и попробуй ещё раз.</p></div></article>';
          }
        }
        grid.innerHTML = html;
        renderPager(data.page||1, data.pages||1);

        if(push){
          var full = window.location.pathname + '?' + params.toString();
          try{ history.pushState({q:params.toString()},'',full); }catch(_){}
        }
        bindAdminQuick();
      })
      .catch(function(err){ console.error('AJAX error:', err); })
      .finally(function(){ setLoading(false); });
  }

  // --- админ быстрые действия (как было)
  function bindAdminQuick(){
    var gridEl=document.getElementById('routes-grid'); if(!gridEl) return;
    function post(url, fd){
      return fetch(url,{method:'POST',body:fd,credentials:'include'})
        .then(function(res){ return res.json().catch(function(){return{};}).then(function(d){return{ok:res.ok,data:d};}); })
        .then(function(x){ if(!x.ok || !x.data.success) throw new Error(x.data.error||'Ошибка'); return x.data; });
    }
    var btns=gridEl.querySelectorAll('.adm-btn');
    for(var i=0;i<btns.length;i++){
      btns[i].addEventListener('click', function(e){
        e.preventDefault(); e.stopPropagation();
        var id=this.getAttribute('data-id'); var act=this.getAttribute('data-adm'); if(!id) return;
        if(act==='delete'){
          if(!confirm('Удалить маршрут #'+id+'?')) return;
          post('/cul/admin/delete/'+id,new FormData()).then(function(){ fetchAndRender({},false); }).catch(function(err){ alert('Ошибка: '+err.message); });
        }else if(act==='publish'){
          post('/cul/admin/toggle_publish/'+id,new FormData()).then(function(){ fetchAndRender({},false); }).catch(function(err){ alert('Ошибка: '+err.message); });
        }else if(act==='edit'){
          document.getElementById('adm_panel')?.classList.add('active');
          var fid=document.getElementById('adm_id'); if(fid) fid.value=id;
        }
      });
    }
  }

  // ---- Слушатели (без перезагрузки) ----
  function debounce(fn, delay){ var t; return function(){ var a=arguments,c=this; clearTimeout(t); t=setTimeout(function(){ fn.apply(c,a); }, delay); }; }
  var debounced = debounce(function(){ fetchAndRender({page:1}, true); }, 350);

  if(qTop){
    qTop.addEventListener('input', debounced);
    qTop.addEventListener('change', debounced);
    qTop.addEventListener('compositionend', debounced);
    qTop.addEventListener('keydown', function(e){
      if(e.key==='Enter'){ e.preventDefault(); fetchAndRender({page:1}, true); }
      if(e.key==='Escape'){ qTop.value=''; fetchAndRender({page:1}, true); }
    });
  }
  if(sort){ sort.addEventListener('change', function(){ fetchAndRender({page:1}, true); }); }

  var applyBtn=document.getElementById('f_apply');
  if(applyBtn){ applyBtn.addEventListener('click', function(){ fetchAndRender({page:1}, true); }); }

  var resetBtn=document.getElementById('f_reset');
  if(resetBtn){ resetBtn.addEventListener('click', function(){
    try{ history.pushState({},'',window.location.pathname); }catch(_){}
    if(qTop) qTop.value=''; if(dmin) dmin.value=''; if(dmax) dmax.value='';
    if(lmin) lmin.value=''; if(lmax) lmax.value='';
    if(rmin) rmin.value='';
    if(cats){ var t=cats.querySelectorAll('.tag.active'); for(var i=0;i<t.length;i++) t[i].classList.remove('active'); }
    if(diff){ var d=diff.querySelectorAll('.tag.active'); for(var j=0;j<d.length;j++) d[j].classList.remove('active'); }
    fetchAndRender({page:1}, true);
  }); }

  // клики по серверной пагинации (если была отрисована) — тоже перехватываем
  document.querySelectorAll('.pager-link').forEach(function(a){
    a.addEventListener('click', function(e){ e.preventDefault(); fetchAndRender({page:this.dataset.page}, true); });
  });

  // back/forward
  window.addEventListener('popstate', function(){ fetchAndRender({}, false); });
})();
</script>

</body>
</html>
