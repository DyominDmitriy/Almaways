<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Культурные маршруты — Almaways</title>
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;800&family=Playfair+Display:wght@700;800&display=swap" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"/>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/admin-toggle.css') }}">
  <style>
    :root{ --ink:#0B1220; --panel:#fff; --muted:#64748b; --ring:#B5CEF5; --secondary:#2E6D9C; }
    html,body{font-family:'Poppins',system-ui,sans-serif;background:#f7fbff;color:var(--ink);margin:0}
    .container{max-width:1200px;margin:0 auto;padding:16px}
    .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:16px}
    @media(max-width:1100px){.grid{grid-template-columns:repeat(2,1fr)}}
    @media(max-width:680px){.grid{grid-template-columns:1fr}}
    .card{background:#fff;border:1px solid #e6eef8;border-radius:14px;overflow:hidden;box-shadow:0 6px 18px rgba(2,6,23,.06)}
    .card .cover{position:relative}
    .card img{display:block;width:100%;aspect-ratio:16/10;object-fit:cover}
    .adm-tools{position:absolute;inset:auto 8px 8px auto;display:flex;gap:6px}
    .adm-btn{background:#fff;border:1px solid #e6eef8;border-radius:10px;padding:.35rem .55rem;box-shadow:0 4px 12px rgba(2,6,23,.06)}
    .info{padding:12px}
    .muted{color:var(--muted)}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:.55rem .9rem;border-radius:999px;border:1px solid #e6eef8;background:#fff;color:var(--ink);text-decoration:none}
    .btn.primary{background:var(--secondary);color:#fff;border-color:var(--secondary)}
    .toolbar{display:flex;justify-content:space-between;align-items:center;margin:8px 0 16px;gap:12px}
    input.input, select.select, textarea.input{width:100%;border:1px solid #e6eef8;border-radius:12px;padding:10px 12px;font:inherit}
    input.input:focus, select.select:focus, textarea.input:focus{outline:2px solid var(--ring)}
    /* Toggle slider */
    .toggle{display:inline-flex;align-items:center;gap:8px}
    .switch{position:relative;display:inline-block;width:42px;height:24px}
    .switch input{display:none}
    .slider{position:absolute;cursor:pointer;inset:0;background:#d1d5db;border-radius:999px;transition:.2s}
    .slider:before{content:"";position:absolute;height:18px;width:18px;left:3px;top:3px;background:white;border-radius:50%;transition:.2s}
    input:checked + .slider{background:#22c55e}
    input:checked + .slider:before{transform:translateX(18px)}
    /* Admin drawer */
    .admin-panel{position:fixed;right:0;top:0;bottom:0;width:min(92vw,480px);background:#fff;border-left:1px solid #e6eef8;box-shadow:0 20px 50px rgba(46,109,156,.22);transform:translateX(100%);transition:.28s;z-index:90;display:flex;flex-direction:column}
    .admin-panel.active{transform:translateX(0)}
    .admin-head{padding:12px 16px;border-bottom:1px solid #e6eef8;display:flex;align-items:center;justify-content:space-between}
    .admin-body{padding:14px 16px;display:grid;gap:12px;overflow:auto}
    
  </style>
</head>
<body>
  <main class="container">
    <div class="toolbar">
      <h1 style="margin:0">Культурные маршруты</h1>
      <div style="display:flex;gap:8px">
        <a href="/index" class="btn">На главную</a>
        {% if current_user.is_authenticated and current_user.is_admin %}
          <button class="btn primary" id="adm_open"><i class="fa-solid fa-wand-magic-sparkles"></i> Админ-панель</button>
        {% endif %}
      </div>
    </div>

    <div class="toolbar">
      <input id="q_top" class="input" placeholder="Поиск по названию/описанию">
      <select id="f_sort" class="select">
        <option value="popular">Популярное</option>
        <option value="new">Сначала новые</option>
      </select>
    </div>

    <section id="routes-grid" class="grid">
      {% for r in routes %}
        <article class="card" data-id="{{ r.id }}">
          <div class="cover">
            <a href="{{ url_for('cul.cul_dynamic', route_id=r.id) }}">
              <img src="{{ r.image_url or url_for('static', filename='img/placeholder.jpg') }}" alt="{{ r.title }}">
            </a>
            {% if current_user.is_authenticated and current_user.is_admin %}
              <div class="adm-tools">
                <button class="adm-btn" data-adm="edit" data-id="{{ r.id }}" title="Редактировать"><i class="fa-regular fa-pen-to-square"></i></button>
                <!-- Toggle slider -->
                <label class="adm-btn adm-toggle" title="Видимость">
                    <span class="adm-switch">
                      <input type="checkbox" class="adm-publish" data-id="{{ r.id }}" {% if r.is_published %}checked{% endif %}>
                      <span class="knob"></span>
                    </span>
                  </label>
                <button class="adm-btn" data-adm="delete" data-id="{{ r.id }}" title="Удалить"><i class="fa-regular fa-trash-can"></i></button>
              </div>
            {% endif %}
          </div>
          <div class="info">
            <h3 style="margin:0 0 6px">{{ r.title }}</h3>
            {% if r.short_description %}<p class="muted" style="margin:6px 0 0">{{ r.short_description }}</p>{% endif %}
          </div>
        </article>
      {% endfor %}
    </section>
  </main>

  {% if current_user.is_authenticated and current_user.is_admin %}
  <aside id="adm_panel" class="admin-panel" aria-label="Админ-панель">
    <div class="admin-head">
      <strong>Редактор маршрута</strong>
      <button id="adm_close" class="btn">Закрыть</button>
    </div>
    <div class="admin-body">
      <form id="adm_form" enctype="multipart/form-data">
        <input type="hidden" name="id" id="adm_id"/>
        <label>
          <div class="muted">Название</div>
          <input class="input" name="title" id="adm_title" required>
        </label>
        <label>
          <div class="muted">Краткое описание</div>
          <textarea class="input" name="short_description" rows="3" id="adm_desc"></textarea>
        </label>
        <label>
          <div class="muted">Полное описание</div>
          <textarea class="input" name="description" rows="4" id="adm_descr_full"></textarea>
        </label>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
          <label>
            <div class="muted">Длительность (ч)</div>
            <input class="input" name="duration" type="number" step="0.5" min="0" id="adm_duration">
          </label>
          <label>
            <div class="muted">Сложность</div>
            <select class="select" name="difficulty" id="adm_difficulty">
              <option value="">—</option><option>Легкая</option><option>Средняя</option><option>Сложная</option>
            </select>
          </label>
        </div>
        <label>
          <div class="muted">Обложка (png/jpg/webp)</div>
          <input class="input" name="image" type="file" accept="image/png, image/jpeg, image/webp" id="adm_image">
        </label>

        <!-- Отдельный слайдер публикации внутри формы (моментально шлет toggle) -->
        <div class="toggle" style="margin-top:6px">
          <span class="muted" style="font-size:.95rem">Опубликован</span>
          <label class="switch">
            <input type="checkbox" id="adm_published">
            <span class="slider"></span>
          </label>
        </div>

        <div style="display:flex;gap:8px;justify-content:flex-end">
          <button id="adm_new" class="btn" type="button">Новый</button>
          <button id="adm_save" class="btn primary" type="submit"><i class="fa-regular fa-floppy-disk"></i> Сохранить</button>
        </div>
      </form>
    </div>
  </aside>
  {% endif %}

  <script>
    // Минимальный клиент для подгрузки JSON витрины
    (function(){
      const API = "/cul/cultural_routes_json";
      const grid = document.getElementById('routes-grid');
      const qTop = document.getElementById('q_top');
      const sort = document.getElementById('f_sort');

      function esc(s){ return String(s||'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }

      function cardHTML(r, isAdmin){
        const toggle = isAdmin ? `
          <label class="toggle adm-btn" title="Вкл/выкл публикацию">
            <span class="muted" style="font-size:.85rem">Visible</span>
            <span class="switch">
              <input type="checkbox" data-adm="publish" data-id="${r.id}" ${r.is_published?'checked':''}>
              <span class="slider"></span>
            </span>
          </label>` : '';

        const adminBtns = isAdmin ? `
          <div class="adm-tools">
            <button class="adm-btn" data-adm="edit" data-id="${r.id}" title="Редактировать"><i class="fa-regular fa-pen-to-square"></i></button>
            ${toggle}
            <button class="adm-btn" data-adm="delete" data-id="${r.id}" title="Удалить"><i class="fa-regular fa-trash-can"></i></button>
          </div>` : '';

        return `
          <article class="card" data-id="${r.id}">
            <div class="cover">
              <a href="/cul/${r.id}"><img src="${esc(r.image_url)}" alt="${esc(r.title)}"></a>
              ${adminBtns}
            </div>
            <div class="info">
              <h3 style="margin:0 0 6px">${esc(r.title)}</h3>
              ${r.short_description ? `<p class="muted" style="margin:6px 0 0">${esc(r.short_description)}</p>`:''}
            </div>
          </article>`;
      }

      async function fetchAndRender(){
        const p = new URLSearchParams();
        const q = (qTop?.value||'').trim();
        if(q) p.set('q', q);
        if(sort?.value) p.set('sort', sort.value);
        const res = await fetch(API+'?'+p.toString(), {credentials:'include'});
        const data = await res.json();
        grid.innerHTML = (data.items||[]).map(it=>cardHTML(it, !!data.is_admin)).join('') || '<div class="muted">Пусто</div>';
      }

      qTop?.addEventListener('input', ()=>fetchAndRender());
      sort?.addEventListener('change', ()=>fetchAndRender());

      // Первичная отрисовка (если захочешь — оставь SSR как есть)
      // fetchAndRender();
    })();
    // внутри cardHTML, формирование блока adm:
    var adm = isAdmin ? (
      '<div class="adm-tools">'+
      '  <button class="adm-btn" data-adm="edit" data-id="'+r.id+'" title="Редактировать"><i class="fa-regular fa-pen-to-square"></i></button>'+
      '  <label class="adm-btn adm-toggle" title="Видимость">'+
      '    <span class="adm-switch">'+
      '      <input type="checkbox" class="adm-publish" data-id="'+r.id+'" '+(r.is_published?'checked':'')+'>'+
      '      <span class="knob"></span>'+
      '    </span>'+
      '  </label>'+
      '  <button class="adm-btn" data-adm="delete" data-id="'+r.id+'" title="Удалить"><i class="fa-regular fa-trash-can"></i></button>'+
      '</div>'
    ) : '';
  </script>

  <script src="{{ url_for('static', filename='js/cul-admin.js') }}"></script>
</body>
</html>